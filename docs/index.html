<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tracking Links</title>
  <style>
    :root {
      --bg: #f8fafc;
      --panel: #ffffff;
      --border: #e5e7eb;
      --text: #0f172a;
      --muted: #6b7280;
      --primary: #2563eb;
      --primary-600: #1d4ed8;
      --ring: rgba(37, 99, 235, 0.25);
      --success: #16a34a;
    }
    html, body { height: 100%; }
    body {
      margin: 0; padding: 32px; background: var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
    }
    .container { max-width: 560px; margin: 0 auto; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 10px 20px rgba(2,6,23,0.04);
      padding: 20px;
    }
    .row { display: flex; gap: 10px; }
    .row + .row { margin-top: 10px; }

    .field {
      position: relative; flex: 1;
    }
    .input {
      width: 100%; height: 44px; padding: 0 14px;
      border: 1px solid var(--border);
      border-radius: 12px; background: #f9fafb;
      outline: none; font-size: 16px; color: var(--text);
      transition: box-shadow .2s ease, border-color .2s ease, background-color .2s ease;
    }
    .input::placeholder { color: #9ca3af; }
    .input:focus {
      background: #fff; border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--ring);
    }

    .btn {
      height: 44px; min-width: 120px; padding: 0 16px; border-radius: 12px; border: 1px solid transparent;
      background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);
      color: white; font-weight: 600; font-size: 15px; cursor: pointer;
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.25);
      transition: filter .15s ease, transform .05s ease;
    }
    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }
    .btn.secondary {
      background: #f3f4f6; color: #111827; border-color: var(--border);
      box-shadow: none;
    }

    .status { margin-top: 12px; color: var(--muted); font-size: 14px; min-height: 20px; }

    .section { margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border); }
    .block { display: grid; gap: 8px; }
    .label { font-size: 13px; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; }

    .link-row { display: flex; align-items: center; gap: 10px; }
    .link {
      display: inline-flex; align-items: center; max-width: 100%;
      padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
      background: #fff; text-decoration: none; color: var(--text); font-size: 14px;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }

    .copy-btn {
      height: 36px; padding: 0 10px; border-radius: 10px; border: 1px solid var(--border);
      background: #f9fafb; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
      transition: background-color .15s ease, border-color .15s ease;
    }
    .copy-btn:hover { background: #fff; border-color: #d1d5db; }
    .copy-icon { width: 16px; height: 16px; fill: currentColor; color: #4b5563; }

    .toast { color: var(--success); font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <form id="trackForm">
        <div class="row">
          <div class="field">
            <input id="orderName" class="input" type="text" placeholder="Order name" required />
          </div>
          <button class="btn" type="submit">Get links</button>
        </div>
      </form>
      <div id="status" class="status"></div>
      <div id="output" style="display:none"></div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script>
    // Preserve remote config so we can fallback if local API isn't available
    const REMOTE_BASE = window.BACKEND_BASE;
    const REMOTE_PATH = window.FUNCTION_PATH;

    // Prefer local API when running on localhost
    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
      window.BACKEND_BASE = '';
      window.FUNCTION_PATH = '/api/links';
    }

    window.BACKEND_BASE = window.BACKEND_BASE || '';
    window.FUNCTION_PATH = window.FUNCTION_PATH || '/api/links';

    function svgCopy() {
      return '<svg class="copy-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9 9V7a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-2v-2h2V7h-6v2H9Z"/><path d="M5 9a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V9Zm2 0v8h6V9H7Z"/></svg>';
    }

    async function copyText(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (e) {
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta); ta.select();
        try { document.execCommand('copy'); return true; } catch { return false; }
        finally { document.body.removeChild(ta); }
      }
    }

    function isRealUrl(link) {
      if (!link || typeof link !== 'string') return false;
      const trimmed = link.trim();
      if (!/^https?:\/\//i.test(trimmed)) return false;
      if (trimmed.includes('#{') || trimmed.includes('${') || trimmed.toLowerCase().includes('{trackingno')) return false;
      return true;
    }

    function resolveTrackingTemplate(rawUrl, trackingNumber) {
      if (!rawUrl || !trackingNumber) return rawUrl;
      let url = String(rawUrl);
      const tn = encodeURIComponent(String(trackingNumber));
      const patterns = [
        /#\{\s*(tracking(?:_?number|_?no|_?num|_?id|_?code)|awb|waybill|consignment|parcel(?:_?id)?)\s*\}/gi,
        /\$\{\s*(tracking(?:_?number|_?no|_?num|_?id|_?code)|awb|waybill|consignment|parcel(?:_?id)?)\s*\}/gi,
        /\{\s*(tracking(?:_?number|_?no|_?num|_?id|_?code)|awb|waybill|consignment|parcel(?:_?id)?)\s*\}/gi,
      ];
      for (const rx of patterns) url = url.replace(rx, tn);
      return url;
    }

    const form = document.getElementById('trackForm');
    const output = document.getElementById('output');
    const status = document.getElementById('status');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      output.style.display = 'none';
      output.innerHTML = '';
      status.textContent = 'Loading...';

      const orderNameRaw = document.getElementById('orderName').value.trim();
      const orderName = orderNameRaw.startsWith('#') ? orderNameRaw : `#${orderNameRaw}`;

      try {
        const base = window.BACKEND_BASE || '';
        const endpointPath = window.BACKEND_BASE ? (window.FUNCTION_PATH || '/links') : '/api/links';
        const resp = await fetch(`${base}${endpointPath}`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderName })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Request failed');

        status.textContent = '';

        const trackingNumber = data.trackingNumber || '';
        const resolvedCourier = resolveTrackingTemplate(data.courierQueryLink, trackingNumber);
        const firstLink = isRealUrl(resolvedCourier)
          ? resolvedCourier
          : (isRealUrl(data.courierQueryLink) ? data.courierQueryLink : null);
        const secondLink = isRealUrl(data.parcelsLink) ? data.parcelsLink : null;

        const blocks = [];

        if (firstLink) {
          blocks.push(`
            <div class="section block">
              <div class="label">Carrier</div>
              <div class="link-row">
                <a class="link" href="${firstLink}" target="_blank" rel="noopener noreferrer">${firstLink}</a>
                <button class="copy-btn" data-copy="${firstLink}" aria-label="Copy carrier link">${svgCopy()}<span>Copy</span></button>
              </div>
            </div>
          `);
        }

        if (secondLink) {
          blocks.push(`
            <div class="section block">
              <div class="label">Universal Search</div>
              <div class="link-row">
                <a class="link" href="${secondLink}" target="_blank" rel="noopener noreferrer">${secondLink}</a>
                <button class="copy-btn" data-copy="${secondLink}" aria-label="Copy universal link">${svgCopy()}<span>Copy</span></button>
              </div>
            </div>
          `);
        }

        if (firstLink || secondLink) {
          const both = [firstLink, secondLink].filter(Boolean).join('\n');
          blocks.push(`
            <div class="section">
              <button class="btn secondary" id="copyBoth" data-copy="${both.replace(/"/g, '&quot;')}">${svgCopy()} Copy both links</button>
              <div id="toast" class="toast" style="margin-top:8px; display:none;">Copied!</div>
            </div>
          `);
        } else {
          blocks.push(`<div class="section">No carrier or universal links found.</div>`);
        }

        output.innerHTML = blocks.join('');
        output.style.display = 'block';

        // Wire copy buttons
        output.querySelectorAll('[data-copy]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const text = btn.getAttribute('data-copy');
            const ok = await copyText(text);
            const toast = document.getElementById('toast');
            if (toast) {
              toast.style.display = 'block';
              toast.textContent = ok ? 'Copied!' : 'Copy failed';
              setTimeout(() => { toast.style.display = 'none'; }, 1200);
            }
          });
        });

      } catch (err) {
        // If local call failed and we have a remote fallback, try it once
        if ((location.hostname === 'localhost' || location.hostname === '127.0.0.1') && REMOTE_BASE) {
          try {
            const orderNameRaw2 = document.getElementById('orderName').value.trim();
            const orderName2 = orderNameRaw2.startsWith('#') ? orderNameRaw2 : `#${orderNameRaw2}`;
            const resp2 = await fetch(`${REMOTE_BASE}${REMOTE_PATH || '/links'}`, {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderName: orderName2 })
            });
            const data2 = await resp2.json();
            if (!resp2.ok) throw new Error(data2.error || 'Request failed');

            status.textContent = '';

            const trackingNumber = data2.trackingNumber || '';
            const resolvedCourier = resolveTrackingTemplate(data2.courierQueryLink, trackingNumber);
            const firstLink = isRealUrl(resolvedCourier)
              ? resolvedCourier
              : (isRealUrl(data2.courierQueryLink) ? data2.courierQueryLink : null);
            const secondLink = isRealUrl(data2.parcelsLink) ? data2.parcelsLink : null;

            const blocks = [];

            if (firstLink) {
              blocks.push(`
                <div class="section block">
                  <div class="label">Carrier</div>
                  <div class="link-row">
                    <a class="link" href="${firstLink}" target="_blank" rel="noopener noreferrer">${firstLink}</a>
                    <button class="copy-btn" data-copy="${firstLink}" aria-label="Copy carrier link">${svgCopy()}<span>Copy</span></button>
                  </div>
                </div>
              `);
            }

            if (secondLink) {
              blocks.push(`
                <div class="section block">
                  <div class="label">Universal Search</div>
                  <div class="link-row">
                    <a class="link" href="${secondLink}" target="_blank" rel="noopener noreferrer">${secondLink}</a>
                    <button class="copy-btn" data-copy="${secondLink}" aria-label="Copy universal link">${svgCopy()}<span>Copy</span></button>
                  </div>
                </div>
              `);
            }

            if (firstLink || secondLink) {
              const both = [firstLink, secondLink].filter(Boolean).join('\n');
              blocks.push(`
                <div class="section">
                  <button class="btn secondary" id="copyBoth" data-copy="${both.replace(/"/g, '&quot;')}">${svgCopy()} Copy both links</button>
                  <div id="toast" class="toast" style="margin-top:8px; display:none;">Copied!</div>
                </div>
              `);
            } else {
              blocks.push(`<div class="section">No carrier or universal links found.</div>`);
            }

            output.innerHTML = blocks.join('');
            output.style.display = 'block';

            output.querySelectorAll('[data-copy]').forEach(btn => {
              btn.addEventListener('click', async () => {
                const text = btn.getAttribute('data-copy');
                const ok = await copyText(text);
                const toast = document.getElementById('toast');
                if (toast) {
                  toast.style.display = 'block';
                  toast.textContent = ok ? 'Copied!' : 'Copy failed';
                  setTimeout(() => { toast.style.display = 'none'; }, 1200);
                }
              });
            });

            return; // success via fallback
          } catch (e2) {
            status.innerHTML = `<span class="error">${e2.message}</span>`;
            return;
          }
        }
        status.innerHTML = `<span class="error">${err.message}</span>`;
      }
    });
  </script>
</body>
</html>
